<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NecesseGame Sinhton by HoangKun</title>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background-color: #000; display: flex; justify-content: center; align-items: center; height: 100vh; font-family: 'VT323', monospace; overflow: hidden; touch-action: none; }
        
        /* --- GIAO DI·ªÜN LOBBY G·ªêC --- */
        #lobby-container {
            width: 100vw; height: 100vh; position: fixed; top: 0; left: 0;
            background: linear-gradient(rgba(0,0,0,0.1), rgba(0,0,0,0.1)), url('https://hoanghamobile.com/tin-tuc/wp-content/uploads/2024/11/pixels-game-thumb.jpg');
            background-size: cover; background-position: center; image-rendering: pixelated;
            display: flex; justify-content: center; align-items: center; z-index: 100;
        }
        .content-area { width: 90%; height: 85%; position: relative; max-width: 1200px; }
        .header { position: absolute; top: 0; left: 0; color: #fff; text-shadow: 4px 4px 0px #000; }
        .header h1 { font-size: 4rem; letter-spacing: 2px; }
        .header p { font-size: 2rem; color: #f4e4bc; }

        .stats-area { position: absolute; top: 0; right: 0; display: flex; gap: 20px; }
        .stat-box {
            background: rgba(93, 64, 55, 0.9); border: 4px solid #3d251e; padding: 8px 20px;
            color: #f4e4bc; font-size: 2rem; box-shadow: 5px 5px 0px #000; display: flex; align-items: center; gap: 10px;
        }

        .menu-options { position: absolute; bottom: 0; right: 0; display: flex; flex-direction: column; gap: 15px; }
        .name-input { width: 220px; height: 45px; background: #3d251e; border: 4px solid #8d6e63; color: #f4e4bc; font-family: 'VT323'; font-size: 1.5rem; text-align: center; outline: none; margin-bottom: 5px; }

        .wood-button {
            width: 220px; height: 65px; background: #8d6e63; border: 4px solid #5d4037; border-bottom: 8px solid #2d1b16;
            color: #f4e4bc; font-size: 2.2rem; cursor: pointer; text-shadow: 2px 2px 0px #000;
            display: flex; justify-content: center; align-items: center; transition: 0.1s;
        }
        .wood-button:hover { background: #a1887f; transform: translateY(-3px); }
        .wood-button:active { transform: translateY(5px); border-bottom: 2px solid #2d1b16; }

        /* --- B·∫¢NG C√ÄI ƒê·∫∂T ƒê·ª¶ √ù --- */
        #settings-modal {
            display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 400px; background: #5d4037; border: 6px solid #3d251e; box-shadow: 10px 10px 0px #000;
            z-index: 1000; padding: 20px; color: #f4e4bc;
        }
        .setting-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; font-size: 1.8rem; }
        #overlay-bg { display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.7); z-index: 998; }

        /* --- GAME & UI --- */
        #game-canvas { display: none; background: #2d6a4f; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 10; image-rendering: pixelated; } /* Th√™m pixelated */
        #ui-controls { display: none; position: fixed; width: 100vw; height: 100vh; top: 0; left: 0; z-index: 50; pointer-events: none; }
        .joystick-base { pointer-events: auto; position: absolute; bottom: 40px; left: 40px; width: 120px; height: 120px; background: rgba(255,255,255,0.2); border-radius: 50%; }
        .joystick-knob { position: absolute; top: 50%; left: 50%; width: 50px; height: 50px; background: rgba(255,255,255,0.5); border-radius: 50%; transform: translate(-50%, -50%); }
        .action-btn { pointer-events: auto; position: absolute; bottom: 50px; right: 50px; width: 80px; height: 80px; background: #8d6e63; border: 4px solid #5d4037; border-radius: 50%; display: flex; justify-content: center; align-items: center; color: #f4e4bc; font-size: 1.5rem; box-shadow: 0 6px 0 #2d1b16; cursor: pointer; }

        #loading-overlay { display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0, 0, 0, 0.9); z-index: 999; flex-direction: column; justify-content: center; align-items: center; color: #f4e4bc; }
        .pixel-spinner { width: 60px; height: 60px; border: 8px solid #5d4037; border-top: 8px solid #f4e4bc; animation: spin 1s steps(8) infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body onclick="initAudio()">
<div id="pause-modal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 9999; justify-content: center; align-items: center; flex-direction: column;">
    <div style="background: #5d4037; border: 6px solid #3d251e; padding: 30px; text-align: center; color: #f4e4bc; box-shadow: 10px 10px 0px #000;">
        <h2 style="font-size: 3rem; margin: 0 0 20px 0;">T·∫†M D·ª™NG</h2>
        <div class="wood-button" onclick="togglePause()" style="width: 200px; padding: 10px; background: #8d6e63; margin-bottom: 10px; cursor: pointer;">TI·∫æP T·ª§C</div>
        <div class="wood-button" onclick="location.reload()" style="width: 200px; padding: 10px; background: #e74c3c; cursor: pointer;">V·ªÄ S·∫¢NH</div>
    </div>
</div>

<div onclick="togglePause()" style="position: fixed; top: 20px; right: 20px; z-index: 999; width: 45px; height: 45px; background: #8d6e63; border: 3px solid #3d251e; color: white; display: flex; justify-content: center; align-items: center; cursor: pointer; font-weight: bold;">||</div>

    <audio id="bgMusic" loop><source src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-2.mp3" type="audio/mpeg"></audio>
    <audio id="clickSound"><source src="https://www.fesliyanstudios.com/play-mp3/6" type="audio/mpeg"></audio>
    <audio id="hitSound"><source src="https://assets.mixkit.co/active_storage/sfx/1393/1393-preview.mp3" type="audio/mpeg"></audio> <div id="overlay-bg" onclick="toggleSettings()"></div>

    <div id="settings-modal">
        <div style="font-size: 3rem; text-align: center; margin-bottom: 20px; border-bottom: 4px solid #3d251e;">C√ÄI ƒê·∫∂T</div>
        <div class="setting-row"><span>√ÇM THANH</span><input type="range" id="volSfx" min="0" max="1" step="0.1" value="0.8"></div>
        <div class="setting-row"><span>NH·∫†C N·ªÄN</span><input type="range" id="volMusic" min="0" max="1" step="0.1" value="0.5" onchange="updateVol()"></div>
        <div class="wood-button" style="width: 100%; height: 50px;" onclick="playClickSound(); toggleSettings()">L∆ØU & ƒê√ìNG</div>
    </div>

    <div id="lobby-container">
        <div id="loading-overlay"><div class="pixel-spinner"></div><div style="font-size: 3rem; margin-top: 20px;">ƒêANG K·∫æT N·ªêI SEVER...VUI L√íNG ƒê·ª¢I </div></div>
        <div class="content-area">
            <div class="header"><h1>NECESSE SINH T·ªíN</h1><p>By HoangKun</p></div>
            <div class="stats-area">
                <div class="stat-box">GOLD: <span id="goldVal">0</span></div>
                <div class="stat-box" style="border-color: #1a237e;">üíé: <span id="diaVal">0</span></div>
            </div>
            <div class="menu-options">
                <input type="text" id="charName" class="name-input" placeholder="T√äN NH√ÇN V·∫¨T..." maxlength="12">
                <div class="wood-button" onclick="playClickSound(); startGame()">TH·∫æ GI·ªöI M·ªöI</div>
                <div class="wood-button" onclick="playClickSound()">TI·∫æP T·ª§C</div>
                <div class="wood-button" onclick="playClickSound(); toggleSettings()">C√ÄI ƒê·∫∂T</div>
                <div class="wood-button" onclick="playClickSound()">THO√ÅT</div>
            </div>
        </div>
    </div>

    <canvas id="game-canvas"></canvas>
    <div id="ui-controls">
        <div class="joystick-base" id="joyBase"><div class="joystick-knob" id="joyKnob"></div></div>
        <div class="action-btn" onmousedown="doAction()" ontouchstart="doAction()">HIT</div>
    </div> 
    <div id="pause-modal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 9999; justify-content: center; align-items: center; flex-direction: column;">
    <div style="background: #5d4037; border: 6px solid #3d251e; padding: 30px; text-align: center; color: #f4e4bc; box-shadow: 10px 10px 0px #000; font-family: 'VT323', monospace;">
        <h2 style="font-size: 3rem; margin: 0 0 20px 0;">T·∫†M D·ª™NG</h2>
        <div class="wood-button" onclick="togglePause()" style="width: 200px; padding: 15px; background: #8d6e63; margin-bottom: 15px; cursor: pointer; border: 3px solid #3d251e;">TI·∫æP T·ª§C</div>
        <div class="wood-button" onclick="location.reload()" style="width: 200px; padding: 15px; background: #e74c3c; cursor: pointer; border: 3px solid #3d251e;">V·ªÄ S·∫¢NH</div>
    </div>
</div>

<div onclick="togglePause()" style="position: fixed; top: 20px; right: 20px; z-index: 999; width: 45px; height: 45px; background: #8d6e63; border: 3px solid #3d251e; color: white; display: flex; justify-content: center; align-items: center; cursor: pointer; font-weight: bold; font-family: Arial;">||</div>

    <script>
    let isPaused = false;

function togglePause() {
    isPaused = !isPaused;
    const modal = document.getElementById('pause-modal');
    if (isPaused) {
        modal.style.display = 'flex';
        if(bgMusic) bgMusic.pause(); // T·∫°m d·ª´ng nh·∫°c
    } else {
        modal.style.display = 'none';
        if(bgMusic) bgMusic.play(); // Ch∆°i ti·∫øp nh·∫°c
        gameLoop(); // Ch·∫°y l·∫°i v√≤ng l·∫∑p game
    }
}

// B·∫•m ph√≠m ESC ƒë·ªÉ t·∫°m d·ª´ng
window.addEventListener('keydown', (e) => {
    if (e.code === 'Escape') togglePause();
});

        const canvas = document.getElementById('game-canvas');
        const ctx = canvas.getContext('2d');
        const clickSound = document.getElementById('clickSound');
        const hitSound = document.getElementById('hitSound'); // √Çm thanh ƒë√°nh
        const bgMusic = document.getElementById('bgMusic');
        
        let stats = { gold: 0, diamonds: 0 };
        let player = { 
            x: 0, y: 0, 
            worldX: 0, worldY: 0, // V·ªã tr√≠ trong th·∫ø gi·ªõi l·ªõn
            size: 32, // K√≠ch th∆∞·ªõc nh√¢n v·∫≠t
            speed: 3, 
            name: "", 
            isHitting: false,
            image: new Image()
        };
        player.image.src = 'assets/player.png'; // ƒê·∫£m b·∫£o ƒë∆∞·ªùng d·∫´n ƒë√∫ng!

        let isGameRunning = false;
        let keys = {};
        let moveVec = { x: 0, y: 0 };

        // --- C·∫§U H√åNH B·∫¢N ƒê·ªí ---
        const TILE_SIZE = 32; // K√≠ch th∆∞·ªõc m·ªói √¥ g·∫°ch
        const WORLD_WIDTH = 2000; // Chi·ªÅu r·ªông th·∫ø gi·ªõi ·∫£o
        const WORLD_HEIGHT = 2000; // Chi·ªÅu cao th·∫ø gi·ªõi ·∫£o

        const mapTiles = []; // M·∫£ng ch·ª©a d·ªØ li·ªáu c√°c √¥ g·∫°ch tr√™n b·∫£n ƒë·ªì
        const entities = []; // M·∫£ng ch·ª©a c√°c v·∫≠t th·ªÉ nh∆∞ c√¢y, ƒë√°

        const grassTile = new Image(); grassTile.src = 'assets/grass.png'; // ·∫¢nh c·ªè
        const treeSprite = new Image(); treeSprite.src = 'assets/tree.png'; // ·∫¢nh c√¢y

        // T·∫°o b·∫£n ƒë·ªì v√† c√°c v·∫≠t th·ªÉ
        function generateWorld() {
            // ƒê·ªï n·ªÅn c·ªè cho to√†n b·ªô b·∫£n ƒë·ªì
            for (let y = 0; y < WORLD_HEIGHT / TILE_SIZE; y++) {
                for (let x = 0; x < WORLD_WIDTH / TILE_SIZE; x++) {
                    mapTiles.push({ x: x * TILE_SIZE, y: y * TILE_SIZE, type: 'grass' });
                }
            }

            // R·∫£i c√¢y ng·∫´u nhi√™n
            for (let i = 0; i < 50; i++) { // 50 c√¢y
                let x = Math.random() * (WORLD_WIDTH - TILE_SIZE);
                let y = Math.random() * (WORLD_HEIGHT - TILE_SIZE);
                entities.push({ x: x, y: y, type: 'tree', width: 48, height: 48, hp: 10 }); // C√¢y c√≥ HP
            }
        }

        // --- C√ÅC H√ÄM X·ª¨ L√ù √ÇM THANH & UI ---
        function playClickSound() { 
            clickSound.volume = document.getElementById('volSfx').value;
            clickSound.currentTime = 0;
            clickSound.play();
        }
        function playHitSound() {
            hitSound.volume = document.getElementById('volSfx').value;
            hitSound.currentTime = 0;
            hitSound.play();
        }

        function initAudio() { if(bgMusic.paused) { bgMusic.volume = 0.5; bgMusic.play(); } }
        function updateVol() { bgMusic.volume = document.getElementById('volMusic').value; }

        function toggleSettings() {
            let isShow = document.getElementById('settings-modal').style.display === 'block';
            document.getElementById('settings-modal').style.display = isShow ? 'none' : 'block';
            document.getElementById('overlay-bg').style.display = isShow ? 'none' : 'block';
        }

        // --- H√ÄM CHUY·ªÇN C·∫¢NH GAME ---
        function startGame() {
            player.name = document.getElementById('charName').value || "H√†nh Gi·∫£";
            document.getElementById('loading-overlay').style.display = 'flex';
            
            // ƒê·∫£m b·∫£o ·∫£nh ƒë√£ t·∫£i xong tr∆∞·ªõc khi v√†o game
            Promise.all([
                new Promise(resolve => player.image.onload = resolve),
                new Promise(resolve => grassTile.onload = resolve),
                new Promise(resolve => treeSprite.onload = resolve)
            ]).then(() => {
                setTimeout(() => {
                    document.getElementById('lobby-container').style.display = 'none';
                    document.getElementById('loading-overlay').style.display = 'none';
                    canvas.style.display = 'block';
                    if ('ontouchstart' in window) document.getElementById('ui-controls').style.display = 'block';
                    
                    canvas.width = window.innerWidth;
                    canvas.height = window.innerHeight;
                    player.x = canvas.width / 2 - player.size / 2; // Gi·ªØa m√†n h√¨nh
                    player.y = canvas.height / 2 - player.size / 2; // Gi·ªØa m√†n h√¨nh
                    player.worldX = WORLD_WIDTH / 2; // B·∫Øt ƒë·∫ßu ·ªü gi·ªØa th·∫ø gi·ªõi
                    player.worldY = WORLD_HEIGHT / 2; // B·∫Øt ƒë·∫ßu ·ªü gi·ªØa th·∫ø gi·ªõi

                    generateWorld(); // T·∫°o b·∫£n ƒë·ªì
                    isGameRunning = true;
                    requestAnimationFrame(gameLoop);
                }, 1500);
            });
        }

        // --- H√ÄNH ƒê·ªòNG C·ª¶A NG∆Ø·ªúI CH∆†I ---
        function doAction() {
            playHitSound(); // Ph√°t ti·∫øng ƒë√°nh
            player.isHitting = true;
            stats.gold += 10;
            document.getElementById('goldVal').innerText = stats.gold;
            
            // X·ª≠ l√Ω ch·∫∑t c√¢y (ki·ªÉm tra va ch·∫°m v·ªõi c√¢y g·∫ßn nh·∫•t)
            for (let i = entities.length - 1; i >= 0; i--) {
                let ent = entities[i];
                if (ent.type === 'tree' && isColliding(player, ent, 50)) { // Trong ph·∫°m vi 50px
                    ent.hp -= 5; // Gi·∫£m m√°u c√¢y
                    if (ent.hp <= 0) {
                        entities.splice(i, 1); // X√≥a c√¢y
                        stats.gold += 50; // Th∆∞·ªüng v√†ng khi ch·∫∑t xong c√¢y
                        document.getElementById('goldVal').innerText = stats.gold;
                    }
                    break; 
                }
            }

            setTimeout(() => player.isHitting = false, 150);
        }

        // Ki·ªÉm tra va ch·∫°m ƒë∆°n gi·∫£n
        function isColliding(obj1, obj2, margin = 0) {
            return obj1.worldX < obj2.x + obj2.width + margin &&
                   obj1.worldX + obj1.size + margin > obj2.x &&
                   obj1.worldY < obj2.y + obj2.height + margin &&
                   obj1.worldY + obj1.size + margin > obj2.y;
        }


        // --- C·∫¨P NH·∫¨T TR·∫†NG TH√ÅI GAME ---
        function update() {
            if(!isGameRunning) return;
            
            let dx = 0;
            let dy = 0;

            // PC Controls
            if(keys['KeyW'] || keys['ArrowUp']) dy -= 1;
            if(keys['KeyS'] || keys['ArrowDown']) dy += 1;
            if(keys['KeyA'] || keys['ArrowLeft']) dx -= 1;
            if(keys['KeyD'] || keys['ArrowRight']) dx += 1;
            
            // Mobile Joystick Controls
            dx += moveVec.x;
            dy += moveVec.y;

            // Chu·∫©n h√≥a vector di chuy·ªÉn ƒë·ªÉ t·ªëc ƒë·ªô kh√¥ng ƒë·ªïi khi ƒëi ch√©o
            if (dx !== 0 || dy !== 0) {
                let magnitude = Math.sqrt(dx*dx + dy*dy);
                dx /= magnitude;
                dy /= magnitude;
            }

            // C·∫≠p nh·∫≠t v·ªã tr√≠ nh√¢n v·∫≠t trong th·∫ø gi·ªõi
            player.worldX += dx * player.speed;
            player.worldY += dy * player.speed;

            // Gi·ªõi h·∫°n nh√¢n v·∫≠t trong bi√™n th·∫ø gi·ªõi
            player.worldX = Math.max(0, Math.min(WORLD_WIDTH - player.size, player.worldX));
            player.worldY = Math.max(0, Math.min(WORLD_HEIGHT - player.size, player.worldY));
        }

        // --- V·∫º C√ÅC ƒê·ªêI T∆Ø·ª¢NG L√äN M√ÄN H√åNH ---
        function draw() {
            if(!isGameRunning) return;

            // Camera offset (parallax scrolling)
            let camX = player.worldX - canvas.width / 2;
            let camY = player.worldY - canvas.height / 2;

            // 1. V·∫Ω b·∫£n ƒë·ªì (√¥ c·ªè)
            ctx.fillStyle = '#2d6a4f'; // M√†u n·ªÅn n·∫øu kh√¥ng c√≥ c·ªè
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            mapTiles.forEach(tile => {
                let screenX = tile.x - camX;
                let screenY = tile.y - camY;
                // Ch·ªâ v·∫Ω nh·ªØng √¥ n·∫±m trong t·∫ßm nh√¨n
                if (screenX + TILE_SIZE > 0 && screenX < canvas.width &&
                    screenY + TILE_SIZE > 0 && screenY < canvas.height) {
                    ctx.drawImage(grassTile, screenX, screenY, TILE_SIZE, TILE_SIZE);
                }
            });

            // 2. V·∫Ω c√°c v·∫≠t th·ªÉ (c√¢y c·ªëi)
            entities.forEach(ent => {
                let screenX = ent.x - camX;
                let screenY = ent.y - camY;
                // Ch·ªâ v·∫Ω nh·ªØng v·∫≠t th·ªÉ n·∫±m trong t·∫ßm nh√¨n
                if (screenX + ent.width > 0 && screenX < canvas.width &&
                    screenY + ent.height > 0 && screenY < canvas.height) {
                    if (ent.type === 'tree') {
                        ctx.drawImage(treeSprite, screenX, screenY, ent.width, ent.height);
                        // V·∫Ω thanh m√°u cho c√¢y khi b·ªã ƒë√°nh
                        if (ent.hp < 10) {
                             ctx.fillStyle = 'red';
                             ctx.fillRect(screenX, screenY - 5, ent.width * (ent.hp/10), 3);
                             ctx.strokeStyle = 'black';
                             ctx.strokeRect(screenX, screenY - 5, ent.width, 3);
                        }
                    }
                }
            });

            // 3. V·∫Ω nh√¢n v·∫≠t (lu√¥n ·ªü gi·ªØa m√†n h√¨nh)
            // ctx.fillStyle = player.isHitting ? '#ffeb3b' : '#e67e22'; // M√†u nh√¢n v·∫≠t c≈©
            // ctx.fillRect(player.x, player.y, player.size, player.size);
            
            // V·∫Ω ·∫£nh nh√¢n v·∫≠t
            ctx.drawImage(player.image, player.x, player.y, player.size, player.size);
            
            // Hi·ªáu ·ª©ng khi ƒë√°nh (ƒë·ªïi m√†u vi·ªÅn)
            if (player.isHitting) {
                ctx.strokeStyle = 'yellow';
                ctx.lineWidth = 2;
                ctx.strokeRect(player.x, player.y, player.size, player.size);
            }

            ctx.fillStyle = 'white'; ctx.font = '20px VT323'; ctx.textAlign = 'center';
            ctx.fillText(player.name, player.x + player.size/2, player.y - 10);
        }

        // --- V√íNG L·∫∂P GAME (GAME LOOP) ---
        function gameLoop() {
            update();
            draw();
            if(isGameRunning) requestAnimationFrame(gameLoop);
        }

        // --- X·ª¨ L√ù S·ª∞ KI·ªÜN ---
        window.addEventListener('keydown', e => {
            keys[e.code] = true;
            if(e.code === 'Space' && isGameRunning) doAction(); // Space ƒë·ªÉ ƒë√°nh tr√™n PC
        });
        window.addEventListener('keyup', e => keys[e.code] = false);

        // JOYSTICK LOGIC
        let stickActive = false;
        const joyBase = document.getElementById('joyBase');
        const joyKnob = document.getElementById('joyKnob');
        joyBase.addEventListener('touchstart', e => { stickActive = true; e.preventDefault(); }); // NgƒÉn cu·ªôn trang
        window.addEventListener('touchmove', e => {
            if (!stickActive) return;
            let t = e.touches[0]; let r = joyBase.getBoundingClientRect();
            let dx = t.clientX - (r.left + r.width/2); let dy = t.clientY - (r.top + r.height/2);
            let d = Math.min(Math.sqrt(dx*dx+dy*dy), r.width/2);
            let ang = Math.atan2(dy, dx);
            moveVec.x = Math.cos(ang) * (d/(r.width/2));
            moveVec.y = Math.sin(ang) * (d/(r.width/2));
            joyKnob.style.transform = `translate(calc(-50% + ${Math.cos(ang)*d}px), calc(-50% + ${Math.sin(ang)*d}px))`;
        }, { passive: false }); // { passive: false } ƒë·ªÉ ngƒÉn cu·ªôn trang
        window.addEventListener('touchend', () => { stickActive = false; moveVec = {x:0, y:0}; joyKnob.style.transform = 'translate(-50%, -50%)'; });

        // X·ª≠ l√Ω resize m√†n h√¨nh
        window.addEventListener('resize', () => {
            if (isGameRunning) {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
                player.x = canvas.width / 2 - player.size / 2;
                player.y = canvas.height / 2 - player.size / 2;
            }
        });
    </script>
</body>
</html>